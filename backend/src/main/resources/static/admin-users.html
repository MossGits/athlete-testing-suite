<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Account Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="/css/theme.css" rel="stylesheet"/>

  <style>
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      padding:1rem;
    }
    .modalCard{
      width:min(720px, 100%);
      background:var(--card, #0f172a);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
      padding:1rem;
    }
    .modalHeader{
      display:flex; align-items:center; gap:.75rem;
    }
    .modalHeader h3{ margin:0; }
    .modalCloseRow{
      margin-left:auto; display:flex; gap:.5rem; align-items:center;
    }
    .modalBody{ margin-top:.75rem; }
    .modalFooter{
      display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;
      margin-top:1rem;
    }
    .modalFooter .pill{ margin-left:auto; }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>Account Dashboard</h1>
    <div class="spacer"></div>
    <span id="who" class="pill"></span>
    <a href="/" class="nav">Home</a>
    <button class="btn ghost" onclick="logout()">Logout</button>
  </div>

  <!-- Only used for errors / notices. -->
  <div id="msg" class="msg" style="margin-bottom: .75rem;"></div>

  <!-- ATHLETE VIEW -->
  <div id="athleteView" class="card" hidden>
    <h2>Diagnostic Tests</h2>
    <p class="note" style="margin-top:.25rem;">
      Select a test to view details. (Launching the live test will be added later.)
    </p>

    <div class="grid two" style="margin-top: 1rem;">
      <div>
        <div id="athleteTestsEmpty" class="note" hidden>No tests found.</div>
        <div id="athleteTestsList" class="list"></div>
      </div>

      <div>
        <h3 style="margin-top:0;">Test Details</h3>
        <pre id="athleteTestDetail" class="note" style="white-space: pre-wrap;">Select a test on the left to view it here.</pre>
      </div>
    </div>
  </div>

  <!-- TRAINER VIEW -->
  <div id="trainerView" class="card" hidden>
    <h2>Trainer Dashboard</h2>
    <p class="note" style="margin-top:.25rem;">
      Select an athlete to view their past tests and run a baseline or active diagnostic session.
    </p>

    <div class="grid two" style="margin-top: 1rem;">
      <!-- Athlete list -->
      <div>
        <h3 style="margin-top:0;">Athletes</h3>
        <div id="athletesEmpty" class="note" hidden>No athletes found for your organization.</div>
        <div id="athletesList" class="list"></div>
      </div>

      <!-- Athlete detail -->
      <div>
        <h3 style="margin-top:0;">Selected Athlete</h3>
        <div id="selectedAthleteCard" class="note">Select an athlete to begin.</div>

        <div style="margin-top: 1rem;">
          <h3>Connect Device</h3>
          <div class="note" style="margin-bottom:.5rem;">
            Connect the Muse on this device. After connecting, choose Baseline or Active to open the test window.
          </div>

          <!-- Muse controls -->
          <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom:.75rem;">
            <button id="btnConnectMuse" class="btn" onclick="connectMuse()" disabled>Connect to Muse</button>
            <button id="btnDisconnectMuse" class="btn ghost" onclick="disconnectMuse()" disabled>Disconnect</button>

            <span id="museStatus" class="pill" style="margin-left:auto;">Muse: Disconnected</span>
            <span id="museBattery" class="pill" hidden>Battery: —</span>
          </div>

          <!-- Test type selection (only enabled after Muse connects + athlete selected) -->
          <div id="testTypeRow" style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
            <button id="btnRunBaseline" class="btn" onclick="openTestModal('baseline')" disabled>Run Baseline</button>
            <button id="btnRunActive" class="btn" onclick="openTestModal('active')" disabled>Run Active</button>
            <span id="testTypeHint" class="note" style="margin-left:auto;">
              Select an athlete and connect Muse to enable.
            </span>
          </div>
        </div>

        <div style="margin-top: 1.25rem;">
          <h3>Past Diagnostic Tests</h3>
          <div id="trainerTestsEmpty" class="note">Select an athlete to load tests.</div>
          <div id="trainerTestsList" class="list"></div>
          <pre id="trainerTestDetail" class="note" style="white-space: pre-wrap; margin-top:.75rem;" hidden></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal (hidden by default) -->
<div id="testModal" class="modalOverlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHeader">
      <h3 id="modalTitle">Run Test</h3>

      <div class="modalCloseRow">
        <span id="modalSub" class="pill">—</span>
        <button class="btn ghost" onclick="closeTestModal()">Close</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="note" id="modalNote">
        Use Start to begin capturing data from the connected Muse.
      </div>

      <div style="margin-top:.75rem;">
        <pre id="modalDebug" class="note" style="white-space: pre-wrap;">Status: Idle</pre>
      </div>

      <!-- Can later show live signal quality, countdown timers, etc. here -->
    </div>

    <div class="modalFooter">
      <button id="modalBtnStart" class="btn" onclick="modalStart()" disabled>Start Test</button>
      <button id="modalBtnSave" class="btn" onclick="modalSave()" disabled>Save</button>
      <button id="modalBtnDiscard" class="btn ghost" onclick="modalDiscard()" disabled>Discard</button>
      <span id="modalStatus" class="pill">Idle</span>
    </div>
  </div>
</div>

<script src="/js/muse/Muse.js"></script>

<script>
  let me = null;
  let selectedAthlete = null;

  // Modal / session state
  let activeModal = {
    open: false,
    type: null,         // 'baseline' | 'active'
    running: false,
  };

  // --- Muse connection foundation (MuseJS + Web Bluetooth) ---
  let muse = null;
  let museConnected = false;

  function setMsg(text, type) {
    const el = document.getElementById('msg');
    el.className = 'msg ' + (type || '');
    el.textContent = text || '';
    el.style.display = text ? 'block' : 'none';
  }

  function fmtDateTime(iso) {
    if (!iso) return 'Unknown date';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);
    return d.toLocaleString(undefined, {
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function sortNewestFirst(arr, key) {
    return [...arr].sort((a, b) => {
      const ta = new Date(a?.[key] ?? a?.dateTime ?? a?.createdAt ?? 0).getTime();
      const tb = new Date(b?.[key] ?? b?.dateTime ?? b?.createdAt ?? 0).getTime();
      return tb - ta;
    });
  }

  async function fetchJson(url) {
    const res = await fetch(url, { credentials: 'include' });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = null; }
    return { ok: res.ok, status: res.status, text, data };
  }

  function canUseWebBluetooth() {
    return !!navigator.bluetooth;
  }

  function setMuseStatus(text) {
    const s = document.getElementById('museStatus');
    if (s) s.textContent = text;
  }

  function setMuseBattery(pct) {
    const b = document.getElementById('museBattery');
    if (!b) return;
    b.hidden = false;
    if (typeof pct === 'number' && isFinite(pct)) b.textContent = `Battery: ${Math.round(pct)}%`;
    else b.textContent = 'Battery: —';
  }

  function updateTrainerButtons() {
    const btnConnect = document.getElementById('btnConnectMuse');
    const btnDisconnect = document.getElementById('btnDisconnectMuse');

    // Test type buttons
    const btnBaseline = document.getElementById('btnRunBaseline');
    const btnActive = document.getElementById('btnRunActive');
    const hint = document.getElementById('testTypeHint');

    // Connect button: enabled if WebBluetooth exists AND not already connected
    if (btnConnect) btnConnect.disabled = !canUseWebBluetooth() || museConnected;

    // Disconnect button: enabled only if connected
    if (btnDisconnect) btnDisconnect.disabled = !museConnected;

    // Baseline/Active: require athlete selected + muse connected + modal not already open
    const canOpenModal = !!selectedAthlete && museConnected && !activeModal.open;
    if (btnBaseline) btnBaseline.disabled = !canOpenModal;
    if (btnActive) btnActive.disabled = !canOpenModal;

    if (hint) {
      if (!selectedAthlete) hint.textContent = 'Select an athlete to enable.';
      else if (!museConnected) hint.textContent = 'Connect Muse to enable.';
      else if (activeModal.open) hint.textContent = 'Test window open.';
      else hint.textContent = 'Ready.';
    }

    // Modal buttons
    const mStart = document.getElementById('modalBtnStart');
    const mSave = document.getElementById('modalBtnSave');
    const mDiscard = document.getElementById('modalBtnDiscard');

    const modalReady = activeModal.open && museConnected && !!selectedAthlete;
    if (mStart) mStart.disabled = !modalReady || activeModal.running;
    if (mSave) mSave.disabled = !activeModal.open || !activeModal.running;
    if (mDiscard) mDiscard.disabled = !activeModal.open || !activeModal.running;
  }

  async function connectMuse() {
    setMsg('');
    if (!canUseWebBluetooth()) {
      setMsg('Web Bluetooth is not available in this browser. Use Chrome or Edge on desktop.', 'warn');
      setMuseStatus('Muse: Unsupported browser');
      return;
    }

    try {
      setMuseStatus('Muse: Connecting…');
      updateTrainerButtons();

      muse = new Muse();           
      await muse.connect();        // triggers device picker

      // This MuseJS sets state=2 on success :contentReference[oaicite:2]{index=2}
      const connected = muse?.state === 2 || (muse?.dev?.gatt && muse.dev.gatt.connected);

      if (!connected) {
        museConnected = false;
        muse = null;
        setMuseStatus('Muse: Not connected (cancelled/failed)');
        const b = document.getElementById('museBattery');
        if (b) b.hidden = true;
        updateTrainerButtons();
        return;
      }

      museConnected = true;
      setMuseStatus('Muse: Connected');
      setMuseBattery(muse?.batteryLevel);
      updateTrainerButtons();
    } catch (err) {
      console.error(err);
      museConnected = false;
      muse = null;
      setMuseStatus('Muse: Disconnected');
      const b = document.getElementById('museBattery');
      if (b) b.hidden = true;
      setMsg('Muse connection failed or was cancelled.', 'warn');
      updateTrainerButtons();
    }
  }

  async function disconnectMuse() {
    setMsg('');
    try {
      if (muse && typeof muse.disconnect === 'function') {
        muse.disconnect(); 
      } else if (muse && muse.dev?.gatt?.connected) {
        try { muse.dev.gatt.disconnect(); } catch {}
      }
    } finally {
      museConnected = false;
      muse = null;
      setMuseStatus('Muse: Disconnected');
      const b = document.getElementById('museBattery');
      if (b) b.hidden = true;

      // If a test window was open, close it when device disconnects
      if (activeModal.open) closeTestModal(true);

      updateTrainerButtons();
    }
  }

  // ---- Modal logic ----
  function openTestModal(type) {
  if (!selectedAthlete) {
    setMsg('Select an athlete first.', 'warn');
    return;
  }
  if (!museConnected) {
    setMsg('Connect Muse first.', 'warn');
    return;
  }

  // TEMP for Step 1: generate a fake sessionId until backend endpoint exists
  const sessionId = crypto.randomUUID();

  const url = (type === 'baseline' ? '/baselinetest.html' : '/activetest.html')
    + `?sessionId=${encodeURIComponent(sessionId)}`
    + `&mode=${encodeURIComponent(type)}`
    + `&athleteId=${encodeURIComponent(selectedAthlete.id || '')}`;

  const w = window.open(
    url,
    type === 'baseline' ? 'baselineTest' : 'activeTest',
    'popup=yes,width=900,height=700'
  );

  if (!w) {
    setMsg('Popup blocked. Allow popups for this site.', 'warn');
    return;
  }

  setMsg(`Opened ${type} test window. Session: ${sessionId}`, '');
}

  function closeTestModal(silent) {
    const modal = document.getElementById('testModal');
    modal.classList.add('hidden');

    activeModal.open = false;
    activeModal.type = null;
    activeModal.running = false;

    if (!silent) setMsg('', '');
    updateTrainerButtons();
  }

  function setModalStatus(pillText, debugText) {
    const pill = document.getElementById('modalStatus');
    const dbg = document.getElementById('modalDebug');
    if (pill) pill.textContent = pillText;
    if (dbg) dbg.textContent = debugText || `Status: ${pillText}`;
  }

  // Placeholder “Start/Save/Discard” inside modal
  // Later, Start will begin streaming EEG to backend and/or starting the pipeline.
  async function modalStart() {
    if (!activeModal.open) return;
    if (!museConnected) {
      setMsg('Muse disconnected. Reconnect to continue.', 'warn');
      closeTestModal(true);
      return;
    }

    activeModal.running = true;
    setModalStatus('Running', 'Status: Running\nCapturing data from Muse…');
    updateTrainerButtons();

    // (Later) start streaming chunks from muse.eeg buffers to backend:
    // muse.eeg[n].read(), etc. :contentReference[oaicite:4]{index=4}
  }

  async function modalSave() {
    if (!activeModal.open || !activeModal.running) return;

    // - baseline: save raw EEG under athlete record
    // - active: store as "active session" for pipeline compare (or save raw too)
    //
    // For now, we just show a status message.
    activeModal.running = false;

    if (activeModal.type === 'baseline') {
      setModalStatus('Saved', 'Status: Saved\n(Placeholder) Baseline would be saved to athlete.');
      setMsg('Baseline saved (placeholder).', '');
    } else {
      setModalStatus('Saved', 'Status: Saved\n(Placeholder) Active would be forwarded to pipeline compare.');
      setMsg('Active test captured (placeholder).', '');
    }

    updateTrainerButtons();
  }

  async function modalDiscard() {
    if (!activeModal.open || !activeModal.running) return;

    activeModal.running = false;
    setModalStatus('Discarded', 'Status: Discarded\nCapture stopped; nothing saved.');
    setMsg('Test discarded (placeholder).', 'warn');
    updateTrainerButtons();
  }

  // Close modal if user clicks overlay background
  document.addEventListener('click', (e) => {
    const modal = document.getElementById('testModal');
    if (!modal || modal.classList.contains('hidden')) return;
    if (e.target === modal) closeTestModal();
  });

  // ESC closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Escape') return;
    const modal = document.getElementById('testModal');
    if (modal && !modal.classList.contains('hidden')) closeTestModal();
  });

  // Handles "ATHLETE", "ROLE_ATHLETE", arrays, authorities
  function normalizedRoleString(me) {
    const raw =
      me?.role ??
      me?.roles ??
      me?.authorities ??
      me?.authority ??
      '';
    if (Array.isArray(raw)) return raw.map(x => String(x)).join(' ').toUpperCase();
    return String(raw).toUpperCase();
  }

  function hasRole(me, token) {
    return normalizedRoleString(me).includes(token.toUpperCase());
  }

  async function init() {
    setMsg('');

    const whoRes = await fetchJson('/api/auth/me');
    if (!whoRes.ok) {
      setMsg('Not authenticated. Redirecting to login…', 'warn');
      setTimeout(() => window.location.href = '/login.html', 700);
      return;
    }

    me = whoRes.data;

    const roleStr = normalizedRoleString(me) || '(unknown role)';
    document.getElementById('who').textContent = `${me.email} • ${roleStr}`;

    const athleteEl = document.getElementById('athleteView');
    const trainerEl = document.getElementById('trainerView');
    athleteEl.hidden = true;
    trainerEl.hidden = true;

    if (hasRole(me, 'ATHLETE')) {
      athleteEl.hidden = false;
      trainerEl.remove();
      await loadAthleteTests();
      return;
    }

    if (hasRole(me, 'TRAINER') || hasRole(me, 'ADMIN')) {
      trainerEl.hidden = false;
      athleteEl.remove();
      await loadTrainerAthletes();

      setMuseStatus('Muse: Disconnected');
      const b = document.getElementById('museBattery');
      if (b) b.hidden = true;
      updateTrainerButtons();
      return;
    }

    setMsg(`Unknown role in /api/auth/me: ${roleStr}`, 'warn');
    athleteEl.hidden = false;
    trainerEl.remove();
  }

  async function loadAthleteTests() {
    const listEl = document.getElementById('athleteTestsList');
    const emptyEl = document.getElementById('athleteTestsEmpty');
    listEl.innerHTML = '';
    emptyEl.hidden = true;

    const r = await fetchJson('/api/muse/tests'); // TODO: implement later
    if (!r.ok) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Tests API not available yet (expected GET /api/muse/tests).';
      return;
    }

    const tests = Array.isArray(r.data) ? r.data : [];
    const ordered = sortNewestFirst(tests, 'startedAt');

    if (ordered.length === 0) {
      emptyEl.hidden = false;
      return;
    }

    ordered.forEach(t => {
      const when = fmtDateTime(t.startedAt || t.dateTime || t.createdAt);
      const label = t.label || 'Muse 2 Test';
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.style.width = '100%';
      btn.style.justifyContent = 'space-between';
      btn.style.marginBottom = '.5rem';
      btn.innerHTML = `<span>${label}</span><span class="pill">${when}</span>`;
      btn.onclick = () => showAthleteTestDetail(t);
      listEl.appendChild(btn);
    });
  }

  function showAthleteTestDetail(test) {
    const el = document.getElementById('athleteTestDetail');
    const when = fmtDateTime(test.startedAt || test.dateTime || test.createdAt);
    el.textContent =
      `Test: ${test.label || 'Muse 2 Test'}\n` +
      `Date/Time: ${when}\n` +
      `\n` +
      `Details:\n` +
      `${test.summary || test.notes || '(No additional details yet.)'}\n` +
      `\n` +
      `(Raw payload)\n` +
      JSON.stringify(test, null, 2);
  }

  async function loadTrainerAthletes() {
    const listEl = document.getElementById('athletesList');
    const emptyEl = document.getElementById('athletesEmpty');
    listEl.innerHTML = '';
    emptyEl.hidden = true;

    let r = await fetchJson('/api/trainer/athletes');
    if (!r.ok) r = await fetchJson('/api/admin/accounts');

    if (!r.ok) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Unable to load athlete list.';
      setMsg(`Failed to load athletes (HTTP ${r.status}).`, 'warn');
      return;
    }

    const all = Array.isArray(r.data) ? r.data : [];

    const myOrg = (me.organizationName || me.org || '').toLowerCase();
    const athletes = all.filter(a => {
      const role = (a.role || '').toUpperCase();
      if (role !== 'ATHLETE') return false;

      if (!myOrg) return true;
      const aOrg = (a.organizationName || a.org || '').toLowerCase();
      return aOrg === myOrg;
    });

    if (athletes.length === 0) {
      emptyEl.hidden = false;
      return;
    }

    athletes.forEach(a => {
      const name = `${a.firstName || ''} ${a.lastName || ''}`.trim() || '(No name)';
      const email = a.email || '';
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.style.width = '100%';
      btn.style.justifyContent = 'space-between';
      btn.style.marginBottom = '.5rem';
      btn.innerHTML = `<span>${name}</span><span class="pill">${email}</span>`;
      btn.onclick = () => selectAthlete(a);
      listEl.appendChild(btn);
    });
  }

  async function selectAthlete(a) {
    selectedAthlete = a;

    const name = `${a.firstName || ''} ${a.lastName || ''}`.trim() || '(No name)';
    const email = a.email || '';
    const org = a.organizationName || a.org || '';

    document.getElementById('selectedAthleteCard').className = 'note';
    document.getElementById('selectedAthleteCard').textContent =
      `${name}\n${email}${org ? '\n' + org : ''}`;

    // If a modal is open and the trainer switches athletes, close it to avoid mis-assignments
    if (activeModal.open) closeTestModal(true);

    updateTrainerButtons();
    await loadTrainerTestsForSelectedAthlete();
  }

  async function loadTrainerTestsForSelectedAthlete() {
    const listEl = document.getElementById('trainerTestsList');
    const emptyEl = document.getElementById('trainerTestsEmpty');
    const detailEl = document.getElementById('trainerTestDetail');

    listEl.innerHTML = '';
    detailEl.hidden = true;

    if (!selectedAthlete) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Select an athlete to load tests.';
      return;
    }

    emptyEl.hidden = true;

    const id = selectedAthlete.id || selectedAthlete.accountId || selectedAthlete.email;
    let r = await fetchJson(`/api/trainer/athletes/${encodeURIComponent(id)}/tests`);

    if (!r.ok) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Tests API not available yet (expected GET /api/trainer/athletes/{id}/tests).';
      return;
    }

    const tests = Array.isArray(r.data) ? r.data : [];
    const ordered = sortNewestFirst(tests, 'startedAt');

    if (ordered.length === 0) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'No tests found for this athlete.';
      return;
    }

    ordered.forEach(t => {
      const when = fmtDateTime(t.startedAt || t.dateTime || t.createdAt);
      const label = t.label || 'Muse 2 Test';
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.style.width = '100%';
      btn.style.justifyContent = 'space-between';
      btn.style.marginBottom = '.5rem';
      btn.innerHTML = `<span>${label}</span><span class="pill">${when}</span>`;
      btn.onclick = () => showTrainerTestDetail(t);
      listEl.appendChild(btn);
    });
  }

  function showTrainerTestDetail(test) {
    const el = document.getElementById('trainerTestDetail');
    const when = fmtDateTime(test.startedAt || test.dateTime || test.createdAt);
    el.hidden = false;
    el.textContent =
      `Test: ${test.label || 'Muse 2 Test'}\n` +
      `Date/Time: ${when}\n` +
      `\n` +
      `Details:\n` +
      `${test.summary || test.notes || '(No additional details yet.)'}\n` +
      `\n` +
      `(Raw payload)\n` +
      JSON.stringify(test, null, 2);
  }

  async function logout() {
    try {
      const res = await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      if (res.ok) window.location.href = '/login.html';
    } catch {}
  }

  init();
</script>
</body>
</html>
