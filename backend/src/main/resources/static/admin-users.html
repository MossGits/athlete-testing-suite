<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Account Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="/css/theme.css" rel="stylesheet"/>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>Account Dashboard</h1>
    <div class="spacer"></div>
    <span id="who" class="pill"></span>
    <a href="/" class="nav">Home</a>
    <button class="btn ghost" onclick="logout()">Logout</button>
  </div>

  <!-- Only used for errors / notices. -->
  <div id="msg" class="msg" style="margin-bottom: .75rem;"></div>

  <!-- ATHLETE VIEW -->
  <div id="athleteView" class="card" hidden>
    <h2>Diagnostic Tests</h2>
    <p class="note" style="margin-top:.25rem;">
      Select a test to view details. (Launching the live test will be added later.)
    </p>

    <div class="grid two" style="margin-top: 1rem;">
      <div>
        <div id="athleteTestsEmpty" class="note" hidden>No tests found.</div>
        <div id="athleteTestsList" class="list"></div>
      </div>

      <div>
        <h3 style="margin-top:0;">Test Details</h3>
        <pre id="athleteTestDetail" class="note" style="white-space: pre-wrap;">Select a test on the left to view it here.</pre>
      </div>
    </div>
  </div>

  <!-- TRAINER VIEW -->
  <div id="trainerView" class="card" hidden>
    <h2>Trainer Dashboard</h2>
    <p class="note" style="margin-top:.25rem;">
      Select an athlete to view their past tests and manage a current diagnostic test session.
    </p>

    <div class="grid two" style="margin-top: 1rem;">
      <!-- Athlete list -->
      <div>
        <h3 style="margin-top:0;">Athletes</h3>
        <div id="athletesEmpty" class="note" hidden>No athletes found for your organization.</div>
        <div id="athletesList" class="list"></div>
      </div>

      <!-- Athlete detail -->
      <div>
        <h3 style="margin-top:0;">Selected Athlete</h3>
        <div id="selectedAthleteCard" class="note">Select an athlete to begin.</div>

        <div style="margin-top: 1rem;">
          <h3>Current Diagnostic Test</h3>
          <div class="note" style="margin-bottom:.5rem;">
            Connect the Muse on this device, then start a diagnostic session for the selected athlete.
          </div>

          <!-- Muse controls -->
          <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom:.5rem;">
            <button id="btnConnectMuse" class="btn" onclick="connectMuse()" disabled>Connect to Muse</button>
            <button id="btnDisconnectMuse" class="btn ghost" onclick="disconnectMuse()" disabled>Disconnect</button>

            <span id="museStatus" class="pill" style="margin-left:auto;">Muse: Disconnected</span>
            <span id="museBattery" class="pill" hidden>Battery: —</span>
          </div>

          <!-- Test controls -->
          <div style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center;">
            <button id="btnStartTest" class="btn" onclick="startCurrentTest()" disabled>Start Test</button>
            <button id="btnSaveTest" class="btn" onclick="saveCurrentTest()" disabled>Save</button>
            <button id="btnDiscardTest" class="btn ghost" onclick="discardCurrentTest()" disabled>Discard</button>
            <span id="currentTestStatus" class="pill" style="margin-left:auto;">Idle</span>
          </div>
        </div>

        <div style="margin-top: 1.25rem;">
          <h3>Past Diagnostic Tests</h3>
          <div id="trainerTestsEmpty" class="note">Select an athlete to load tests.</div>
          <div id="trainerTestsList" class="list"></div>
          <pre id="trainerTestDetail" class="note" style="white-space: pre-wrap; margin-top:.75rem;" hidden></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/js/muse/Muse.js"></script>

<script>
  let me = null;
  let selectedAthlete = null;
  let currentTestState = { running: false };

  // --- Muse connection foundation (MuseJS + Web Bluetooth) ---
  let muse = null;
  let museConnected = false;

  function setMsg(text, type) {
    const el = document.getElementById('msg');
    el.className = 'msg ' + (type || '');
    el.textContent = text || '';
    el.style.display = text ? 'block' : 'none';
  }

  function fmtDateTime(iso) {
    if (!iso) return 'Unknown date';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);
    return d.toLocaleString(undefined, {
      year: 'numeric', month: 'short', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function sortNewestFirst(arr, key) {
    return [...arr].sort((a, b) => {
      const ta = new Date(a?.[key] ?? a?.dateTime ?? a?.createdAt ?? 0).getTime();
      const tb = new Date(b?.[key] ?? b?.dateTime ?? b?.createdAt ?? 0).getTime();
      return tb - ta;
    });
  }

  async function fetchJson(url) {
    const res = await fetch(url, { credentials: 'include' });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = null; }
    return { ok: res.ok, status: res.status, text, data };
  }

  function canUseWebBluetooth() {
    return !!navigator.bluetooth;
  }

  function setMuseStatus(text) {
    const s = document.getElementById('museStatus');
    if (s) s.textContent = text;
  }

  function setMuseBattery(pct) {
    const b = document.getElementById('museBattery');
    if (!b) return;

    b.hidden = false;

    if (typeof pct === 'number' && isFinite(pct)) {
      b.textContent = `Battery: ${Math.round(pct)}%`;
    } else {
      b.textContent = 'Battery: —';
    }
  }

  function updateTrainerButtons() {
    const btnConnect = document.getElementById('btnConnectMuse');
    const btnDisconnect = document.getElementById('btnDisconnectMuse');
    const btnStart = document.getElementById('btnStartTest');
    const btnSave = document.getElementById('btnSaveTest');
    const btnDiscard = document.getElementById('btnDiscardTest');

    // Connect button: enabled if WebBluetooth exists AND not already connected
    if (btnConnect) btnConnect.disabled = !canUseWebBluetooth() || museConnected;

    // Disconnect button: enabled only if connected
    if (btnDisconnect) btnDisconnect.disabled = !museConnected;

    // Start test: requires athlete selected + muse connected + not running
    const canStart = !!selectedAthlete && museConnected && !currentTestState.running;
    if (btnStart) btnStart.disabled = !canStart;

    // Save/Discard only when running
    if (btnSave) btnSave.disabled = !currentTestState.running;
    if (btnDiscard) btnDiscard.disabled = !currentTestState.running;
  }

  async function connectMuse() {
    setMsg('');
    if (!canUseWebBluetooth()) {
      setMsg('Web Bluetooth is not available in this browser. Use Chrome or Edge on desktop.', 'warn');
      setMuseStatus('Muse: Unsupported browser');
      return;
    }

    try {
      setMuseStatus('Muse: Connecting…');
      updateTrainerButtons();

      // MuseJS must be loaded (from /js/muse/Muse.js)
      muse = new Muse();

      // This triggers the browser device picker (must be called from a user click)
      await muse.connect();

      museConnected = true;
      setMuseStatus('Muse: Connected');

      // Battery
      setMuseBattery(muse?.batteryLevel);

      try {
        if (typeof muse?.getBatteryLevel === 'function') {
          const pct = await muse.getBatteryLevel();
          setMuseBattery(pct);
        }
      } catch {}

      updateTrainerButtons();
    } catch (err) {
      console.error(err);
      museConnected = false;
      muse = null;
      setMuseStatus('Muse: Disconnected');
      const b = document.getElementById('museBattery');
      if (b) b.hidden = true;
      setMsg('Muse connection failed or was cancelled.', 'warn');
      updateTrainerButtons();
    }
  }

  async function disconnectMuse() {
    setMsg('');
    try {
      if (muse && typeof muse.disconnect === 'function') {
        await muse.disconnect();
      } else if (muse && muse.device?.gatt?.connected) {
        try { muse.device.gatt.disconnect(); } catch {}
      }
    } finally {
      museConnected = false;
      muse = null;
      setMuseStatus('Muse: Disconnected');
      const b = document.getElementById('museBattery');
      if (b) b.hidden = true;
      updateTrainerButtons();
    }
  }

  // Handles "ATHLETE", "ROLE_ATHLETE", arrays, authorities
  function normalizedRoleString(me) {
    const raw =
      me?.role ??
      me?.roles ??
      me?.authorities ??
      me?.authority ??
      '';

    if (Array.isArray(raw)) return raw.map(x => String(x)).join(' ').toUpperCase();
    return String(raw).toUpperCase();
  }

  function hasRole(me, token) {
    return normalizedRoleString(me).includes(token.toUpperCase());
  }

  async function init() {
    setMsg('');

    // Who am I
    const whoRes = await fetchJson('/api/auth/me');
    if (!whoRes.ok) {
      setMsg('Not authenticated. Redirecting to login…', 'warn');
      setTimeout(() => window.location.href = '/login.html', 700);
      return;
    }

    me = whoRes.data;

    const roleStr = normalizedRoleString(me) || '(unknown role)';
    document.getElementById('who').textContent = `${me.email} • ${roleStr}`;

    // Always start hidden
    const athleteEl = document.getElementById('athleteView');
    const trainerEl = document.getElementById('trainerView');
    athleteEl.hidden = true;
    trainerEl.hidden = true;

    // Show one dashboard, and remove the other from the DOM entirely
    if (hasRole(me, 'ATHLETE')) {
      athleteEl.hidden = false;
      trainerEl.remove();            // athlete can never see trainer UI
      await loadAthleteTests();
      return;
    }

    if (hasRole(me, 'TRAINER') || hasRole(me, 'ADMIN')) {
      trainerEl.hidden = false;
      athleteEl.remove();            // trainer doesn’t need athlete view
      await loadTrainerAthletes();

      // Initialize Muse button state for trainers
      setMuseStatus('Muse: Disconnected');
      const b = document.getElementById('museBattery');
      if (b) b.hidden = true;
      updateTrainerButtons();

      return;
    }

    // Unknown role -> athlete-style view only
    setMsg(`Unknown role in /api/auth/me: ${roleStr}`, 'warn');
    athleteEl.hidden = false;
    trainerEl.remove();
  }

  async function loadAthleteTests() {
    const listEl = document.getElementById('athleteTestsList');
    const emptyEl = document.getElementById('athleteTestsEmpty');
    listEl.innerHTML = '';
    emptyEl.hidden = true;

    const r = await fetchJson('/api/muse/tests'); // TODO: implement later
    if (!r.ok) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Tests API not available yet (expected GET /api/muse/tests).';
      return;
    }

    const tests = Array.isArray(r.data) ? r.data : [];
    const ordered = sortNewestFirst(tests, 'startedAt');

    if (ordered.length === 0) {
      emptyEl.hidden = false;
      return;
    }

    ordered.forEach(t => {
      const when = fmtDateTime(t.startedAt || t.dateTime || t.createdAt);
      const label = t.label || 'Muse 2 Test';
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.style.width = '100%';
      btn.style.justifyContent = 'space-between';
      btn.style.marginBottom = '.5rem';
      btn.innerHTML = `<span>${label}</span><span class="pill">${when}</span>`;
      btn.onclick = () => showAthleteTestDetail(t);
      listEl.appendChild(btn);
    });
  }

  function showAthleteTestDetail(test) {
    const el = document.getElementById('athleteTestDetail');
    const when = fmtDateTime(test.startedAt || test.dateTime || test.createdAt);
    el.textContent =
      `Test: ${test.label || 'Muse 2 Test'}\n` +
      `Date/Time: ${when}\n` +
      `\n` +
      `Details:\n` +
      `${test.summary || test.notes || '(No additional details yet.)'}\n` +
      `\n` +
      `(Raw payload)\n` +
      JSON.stringify(test, null, 2);
  }

  async function loadTrainerAthletes() {
    const listEl = document.getElementById('athletesList');
    const emptyEl = document.getElementById('athletesEmpty');
    listEl.innerHTML = '';
    emptyEl.hidden = true;

    let r = await fetchJson('/api/trainer/athletes');
    if (!r.ok) r = await fetchJson('/api/admin/accounts');

    if (!r.ok) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Unable to load athlete list.';
      setMsg(`Failed to load athletes (HTTP ${r.status}).`, 'warn');
      return;
    }

    const all = Array.isArray(r.data) ? r.data : [];

    const myOrg = (me.organizationName || me.org || '').toLowerCase();
    const athletes = all.filter(a => {
      const role = (a.role || '').toUpperCase();
      if (role !== 'ATHLETE') return false;

      if (!myOrg) return true;
      const aOrg = (a.organizationName || a.org || '').toLowerCase();
      return aOrg === myOrg;
    });

    if (athletes.length === 0) {
      emptyEl.hidden = false;
      return;
    }

    athletes.forEach(a => {
      const name = `${a.firstName || ''} ${a.lastName || ''}`.trim() || '(No name)';
      const email = a.email || '';
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.style.width = '100%';
      btn.style.justifyContent = 'space-between';
      btn.style.marginBottom = '.5rem';
      btn.innerHTML = `<span>${name}</span><span class="pill">${email}</span>`;
      btn.onclick = () => selectAthlete(a);
      listEl.appendChild(btn);
    });
  }

  async function selectAthlete(a) {
    selectedAthlete = a;

    const name = `${a.firstName || ''} ${a.lastName || ''}`.trim() || '(No name)';
    const email = a.email || '';
    const org = a.organizationName || a.org || '';

    document.getElementById('selectedAthleteCard').className = 'note';
    document.getElementById('selectedAthleteCard').textContent =
      `${name}\n${email}${org ? '\n' + org : ''}`;

    // Reset current test UI state
    document.getElementById('currentTestStatus').textContent = 'Idle';
    currentTestState.running = false;

    updateTrainerButtons();
    await loadTrainerTestsForSelectedAthlete();
  }

  async function loadTrainerTestsForSelectedAthlete() {
    const listEl = document.getElementById('trainerTestsList');
    const emptyEl = document.getElementById('trainerTestsEmpty');
    const detailEl = document.getElementById('trainerTestDetail');

    listEl.innerHTML = '';
    detailEl.hidden = true;

    if (!selectedAthlete) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Select an athlete to load tests.';
      return;
    }

    emptyEl.hidden = true;

    const id = selectedAthlete.id || selectedAthlete.accountId || selectedAthlete.email;
    let r = await fetchJson(`/api/trainer/athletes/${encodeURIComponent(id)}/tests`);

    if (!r.ok) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'Tests API not available yet (expected GET /api/trainer/athletes/{id}/tests).';
      return;
    }

    const tests = Array.isArray(r.data) ? r.data : [];
    const ordered = sortNewestFirst(tests, 'startedAt');

    if (ordered.length === 0) {
      emptyEl.hidden = false;
      emptyEl.textContent = 'No tests found for this athlete.';
      return;
    }

    ordered.forEach(t => {
      const when = fmtDateTime(t.startedAt || t.dateTime || t.createdAt);
      const label = t.label || 'Muse 2 Test';
      const btn = document.createElement('button');
      btn.className = 'btn ghost';
      btn.style.width = '100%';
      btn.style.justifyContent = 'space-between';
      btn.style.marginBottom = '.5rem';
      btn.innerHTML = `<span>${label}</span><span class="pill">${when}</span>`;
      btn.onclick = () => showTrainerTestDetail(t);
      listEl.appendChild(btn);
    });
  }

  function showTrainerTestDetail(test) {
    const el = document.getElementById('trainerTestDetail');
    const when = fmtDateTime(test.startedAt || test.dateTime || test.createdAt);
    el.hidden = false;
    el.textContent =
      `Test: ${test.label || 'Muse 2 Test'}\n` +
      `Date/Time: ${when}\n` +
      `\n` +
      `Details:\n` +
      `${test.summary || test.notes || '(No additional details yet.)'}\n` +
      `\n` +
      `(Raw payload)\n` +
      JSON.stringify(test, null, 2);
  }

  // Current-test controls (still placeholders, gated by Muse connection + selected athlete)
  function startCurrentTest() {
    if (!selectedAthlete) return;
    if (!museConnected) {
      setMsg('Connect to Muse before starting a test.', 'warn');
      return;
    }

    currentTestState.running = true;
    document.getElementById('currentTestStatus').textContent = 'Running';
    updateTrainerButtons();
  }

  function saveCurrentTest() {
    if (!currentTestState.running) return;

    currentTestState.running = false;
    document.getElementById('currentTestStatus').textContent = 'Saved (placeholder)';
    updateTrainerButtons();
  }

  function discardCurrentTest() {
    if (!currentTestState.running) return;

    currentTestState.running = false;
    document.getElementById('currentTestStatus').textContent = 'Discarded (placeholder)';
    updateTrainerButtons();
  }

  async function logout() {
    try {
      const res = await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      if (res.ok) window.location.href = '/login.html';
    } catch {}
  }

  init();
</script>
</body>
</html>
